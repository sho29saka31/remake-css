<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
/* ãŠã‚‰ãµãã‚“æ¤œå®šç”¨ã‚¹ã‚¿ã‚¤ãƒ« - ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼: #54C3F1 */

@import url('https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap');

body {
  font-family: 'Yuji Syuku', serif;
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  background: #475950;
}

.container {
  background: white;
  border-radius: 16px;
  padding: 30px 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

h1 {
  color: #54C3F1;
  text-align: center;
  margin: 0 0 10px 0;
  font-size: 32px;
  font-weight: bold;
}

.subtitle {
  text-align: center;
  color: #666;
  margin: 0 0 10px 0;
  font-size: 16px;
}

.warning-message {
  text-align: center;
  color: #d32f2f;
  margin: 0 0 25px 0;
  font-size: 14px;
  font-weight: bold;
  background: #ffebee;
  padding: 10px 15px;
  border-radius: 8px;
}

.level-buttons {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-bottom: 20px;
  max-width: 500px;
  margin-left: auto;
  margin-right: auto;
}

.level-button {
  width: 100%;
  padding: 20px;
  font-size: 20px;
  font-weight: bold;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  color: white;
  box-shadow: 0 4px 12px rgba(84,195,241,0.3);
  text-align: center;
  border: none;
  font-family: 'Yuji Syuku', serif;
}

.level-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(84,195,241,0.4);
}

.level-button:active {
  transform: translateY(-1px);
}

.beginner {
  background: linear-gradient(135deg, #89D4F5 0%, #54C3F1 100%);
  border: 3px solid #89D4F5;
}

.intermediate {
  background: linear-gradient(135deg, #54C3F1 0%, #2FA3D8 100%);
  border: 3px solid #54C3F1;
}

.advanced {
  background: linear-gradient(135deg, #2FA3D8 0%, #1B7FAD 100%);
  border: 3px solid #2FA3D8;
}

.form-container {
  margin-top: 20px;
  display: none;
}

.form-container.active {
  display: block;
}

#form-iframe {
  width: 100%;
  height: 800px;
  border: none;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.result-button {
  width: 100%;
  max-width: 500px;
  padding: 15px;
  font-size: 18px;
  font-weight: bold;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  background: linear-gradient(135deg, #54C3F1 0%, #2FA3D8 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(84,195,241,0.3);
  margin: 20px auto 0;
  display: block;
  transition: all 0.3s ease;
  font-family: 'Yuji Syuku', serif;
}

.result-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(84,195,241,0.4);
}

.hidden {
  display: none;
}

.result-display {
  margin-top: 20px;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}

.success-icon {
  font-size: 80px;
  margin-bottom: 20px;
}

.fail-icon {
  font-size: 80px;
  margin-bottom: 20px;
}

.result-display h2 {
  margin: 0 0 15px 0;
  font-size: 32px;
  color: #54C3F1;
}

.result-display .message {
  font-size: 18px;
  margin-bottom: 20px;
  color: #666;
  line-height: 1.6;
}

.result-display .details {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 12px;
  margin-top: 20px;
}

.result-display .details h3 {
  margin: 0 0 15px 0;
  font-size: 20px;
  color: #333;
}

.result-display .details p {
  margin: 8px 0;
  color: #666;
  font-size: 16px;
}

.loading {
  text-align: center;
  padding: 60px 20px;
}

.spinner {
  border: 5px solid #f3f3f3;
  border-top: 5px solid #54C3F1;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 30px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.retry-button {
  padding: 15px 30px;
  font-size: 18px;
  font-weight: bold;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  background: linear-gradient(135deg, #54C3F1 0%, #2FA3D8 100%);
  color: white;
  margin-top: 15px;
  transition: all 0.3s ease;
  font-family: 'Yuji Syuku', serif;
}

.retry-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(84,195,241,0.3);
}

.temporary-message {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #54C3F1;
  color: white;
  padding: 18px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(84,195,241,0.4);
  z-index: 1000;
  font-size: 16px;
  font-weight: bold;
  animation: slideDown 0.3s ease-out;
  max-width: 90%;
  text-align: center;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

.result-check-area {
  padding: 20px;
  margin: 20px 0;
  font-size: 20px;
  font-weight: bold;
  text-align: center;
  color: white;
  background: linear-gradient(135deg, #89D4F5 0%, #54C3F1 100%);
  border-radius: 12px;
  cursor: default;
  user-select: none;
  border: 3px solid #89D4F5;
}

.result-check-area.clickable {
  cursor: pointer;
  transition: all 0.3s ease;
}

.result-check-area.clickable:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(84, 195, 241, 0.5);
}

.download-help {
  margin-top: 10px;
  font-size: 14px;
  color: #666;
}

.download-help a {
  color: #54C3F1;
  text-decoration: underline;
}

#scroll-to-top {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #54C3F1 0%, #2FA3D8 100%);
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(84,195,241,0.3);
  display: none;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  z-index: 999;
}

#scroll-to-top.visible {
  display: flex;
}

#scroll-to-top:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(84,195,241,0.4);
}

@media (max-width: 768px) {
  body {
    padding: 10px;
  }
  
  .container {
    padding: 20px 15px;
  }
  
  h1 {
    font-size: 28px;
  }
  
  .level-button {
    padding: 18px;
    font-size: 18px;
  }
  
  #scroll-to-top {
    width: 50px;
    height: 50px;
    bottom: 20px;
    right: 20px;
    font-size: 20px;
  }
}
  </style>
</head>
<body>
  <div class="container">
    <h1 id="kentei-title">æ¤œå®š</h1>

    <!-- ã‚¯ãƒªãƒƒã‚¯ã‚¨ãƒªã‚¢ï¼ˆçµæœç¢ºèªç”¨ï¼‰ -->
    <div id="result-check-area" class="result-check-button hidden" onclick="checkResult()">
      æ¤œå®šã‚’å—ã‘ã¦åˆæ ¼è¨¼ã‚’ã‚²ãƒƒãƒˆã—ã‚ˆã†ï¼
    </div>

    <p class="subtitle" id="level-instruction">ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    <p class="warning-message">ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã¯åˆ©ç”¨ã—ãªã„ã§ãã ã•ã„</p>

    <div class="level-buttons" id="level-buttons-container">
      <button class="level-button beginner" onclick="loadForm('Lv1')">Lv1</button>
      <button class="level-button intermediate" onclick="loadForm('Lv2')">Lv2</button>
      <button class="level-button advanced" onclick="loadForm('Lv3')">Lv3</button>
    </div>

    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <h2>åˆæ ¼è¨¼ã‚’ç¢ºèªä¸­...</h2>
      <p class="message">å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</p>
    </div>

    <div id="result" class="result-display hidden"></div>

    <div class="form-container" id="form-container">
      <iframe id="form-iframe" class="form-area"></iframe>
    </div>

    <div id="temporary-message" class="temporary-message hidden"></div>

  </div>

  <button id="scroll-to-top" class="scroll-to-top-button" onclick="scrollToTop()">â†‘</button>

  <script>
    // ============================================
    // è¨­å®š: ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿å¤‰æ›´ã—ã¦ãã ã•ã„
    // ============================================

    // Xï¼ˆTwitterï¼‰ã‚·ã‚§ã‚¢è¨­å®š
    const SHARE_CONFIG = {
      pageUrl: 'https://sites.google.com/view/nomynoma-ggg-1/', // å…±æœ‰æ™‚ã«å«ã‚ã‚‹URLï¼ˆç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ç¾åœ¨ã®ãƒšãƒ¼ã‚¸URLã‚’ä½¿ç”¨ï¼‰
      passedMessage: 'Dæ¤œã®{kentei} {level} ã«åˆæ ¼ã—ã¾ã—ãŸï¼ğŸ‰\nã‚¹ã‚³ã‚¢: {score}ç‚¹ / 100ç‚¹', // åˆæ ¼æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ{kentei}, {level}, {score}ãŒç½®æ›ã•ã‚Œã¾ã™ï¼‰
      failedMessage: 'Dæ¤œã®{kentei} {level} ã«æŒ‘æˆ¦ã—ã¾ã—ãŸï¼\næ¬¡ã“ãã¯åˆæ ¼ã™ã‚‹ãï¼ğŸ’ª' // ä¸åˆæ ¼æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    };

    // æ¤œå®šè¨­å®š
    const KENTEI_CONFIG = {
      'G1': {
        displayName: 'â˜ƒï¸æ¤œå®š',
        levels: {
          'Lv1': {
            displayName: 'åˆç´š',
            gasApiUrl: 'https://script.google.com/macros/s/AKfycbznDjw7a2gwZVvcy_IVMfMlPfL7b12OlyzLyip8mEmO_a1Wwjj9yIRNWDqFveDVd6M/exec',
            forms: [
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLSczhqXv5RUxxpZ7TC0On-27dlYipis1cFdCpI0fcXFHwQVdnA/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLScbtYM_u7xVJRe9izdkqsgJ3BKDmzOC7YadBwDOteCoL2-Z0Q/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLSfrFHj5RdfAnUePItY6teFT9EPgox1_hO5pDXYCDt5bPecW3w/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLSeyqHVQ4xvsCrO7-njl63P2MKKZS1VQSQ0-QlYuciRqYYx5Qw/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLScLBCQi4e7WrVlTzygL52h4CudDXeqGkmNuOJG1973VLzUksg/viewform', entryId: '950292422' }
            ]
          },
          'Lv2': {
            displayName: 'ä¸­ç´š',
            gasApiUrl: 'https://script.google.com/macros/s/AKfycbxp3p6GS2epHk68dvrV_MeVXkmDy029p1YRmbbdbH6DzkV42Z-FWNjCroc0HokSM_k/exec',
            forms: [
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLSfMN3cK-4Kg6m21OvyRIRbIiWEwGmjnQilnPhH6_HL8MznnCw/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLScv0X2DvqNKUhNLqx_ZSsLG0l9Pz3rZzWEC7Nx3wXA3qBWF3A/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLSfIKg-ExrAOrURIQUJ9GbP0qJdiYIkz_hSnmPwCkRoiMxNlbw/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLSeQvHLUtS7_yULv7XMs2T9Fv6omTJc0MLl6ZQH1SXXU07RLVQ/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLSfQnargxCeQxmz2k6POg91V4-cvtL_XE-3GJHWGn2lGjKKaEw/viewform', entryId: '950292422' }
            ]
          },
          'Lv3': {
            displayName: 'ä¸Šç´š',
            gasApiUrl: 'https://script.google.com/macros/s/AKfycbyf88n2FFASPN8JmnujV26CtfymL39ocjtGJKhHnOfExlH3cFswU54tIN4q-gkfMlU/exec',
            forms: [
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLScTiS3SNySQzLW9i0-4oq69n6muXfKcKJRsuZnmCWP9FM21ug/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLScRkRlgLEG7DeYSSa-jVHNk4T64Pn62Dl55AS-XOY0p0zo5rQ/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLSe2AfOHa9oZHoSICzR0TXyt1zLi-XqEdLq68p8NAUAa7DBsjg/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLSe9cQ7R3iHiqVGzClFxK9ZH1hk8kt5iCimlWcg1lJjFG_lyGQ/viewform', entryId: '950292422' },
              { url: 'https://docs.google.com/forms/d/e/1FAIpQLSeMEF96m-459fp_VA0M6TS7VhWZaAFC9-RlD4QOmUlxFPnsBQ/viewform', entryId: '950292422' }
            ]
          }
        }
      }
    };

    // ============================================
    // ä»¥ä¸‹ã¯å¤‰æ›´ä¸è¦ï¼ˆè‡ªå‹•çš„ã«å°å‡ºã•ã‚Œã‚‹ï¼‰
    // ============================================

    // ç¾åœ¨ã®æ¤œå®šè¨­å®šã‹ã‚‰å€¤ã‚’å–å¾—
    const KENTEI_NAME = Object.keys(KENTEI_CONFIG)[0];  // 'G1'
    const CURRENT_KENTEI = KENTEI_CONFIG[KENTEI_NAME];
    const LEVEL_NAMES = Object.keys(CURRENT_KENTEI.levels);  // ['Lv1', 'Lv2', 'Lv3']

    // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã€æ—¢å­˜ã®å½¢å¼ã§ã‚‚å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    const KENTEI_DISPLAY_NAMES = {
      [KENTEI_NAME]: CURRENT_KENTEI.displayName
    };

    const LEVEL_DISPLAY_NAMES = {};
    LEVEL_NAMES.forEach(level => {
      LEVEL_DISPLAY_NAMES[level] = CURRENT_KENTEI.levels[level].displayName;
    });

    const GAS_API_URLS = {
      [KENTEI_NAME]: {}
    };
    LEVEL_NAMES.forEach(level => {
      GAS_API_URLS[KENTEI_NAME][level] = CURRENT_KENTEI.levels[level].gasApiUrl;
    });

    const FORM_CONFIG = {
      [KENTEI_NAME]: {}
    };
    LEVEL_NAMES.forEach(level => {
      FORM_CONFIG[KENTEI_NAME][level] = CURRENT_KENTEI.levels[level].forms;
    });


    // å—é¨“ç•ªå·ç”Ÿæˆé–¢æ•°ï¼ˆ6æ¡è‹±æ•°å­—ï¼‰
    function generateExamNumber() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let examNumber = '';
      for (let i = 0; i < 6; i++) {
        examNumber += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return examNumber;
    }

    // ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãƒ—ãƒªãƒ•ã‚£ãƒ«URLã‚’ç”Ÿæˆ
    function generatePrefilledUrl(level) {
      const kentei = KENTEI_NAME;
      const forms = FORM_CONFIG[kentei][level];

      if (!forms || forms.length === 0) {
        console.error('ã‚¨ãƒ©ãƒ¼: ã“ã®ãƒ¬ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return '';
      }

      // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸æŠ
      const randomIndex = Math.floor(Math.random() * forms.length);
      const selectedForm = forms[randomIndex];

      // å—é¨“ç•ªå·ã‚’å–å¾—
      const examNumber = sessionStorage.getItem('quizSessionExamNumber');

      // é¸æŠã—ãŸãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’SessionStorageã«ä¿å­˜ï¼ˆGASæ¤œç´¢ç”¨ï¼‰
      sessionStorage.setItem('quizSessionKentei', kentei);
      sessionStorage.setItem('quizSessionLevel', level);
      sessionStorage.setItem('quizSessionSheetIndex', randomIndex.toString());

      // ãƒ—ãƒªãƒ•ã‚£ãƒ«URLã‚’æ§‹ç¯‰
      const prefilledUrl = `${selectedForm.url}?usp=pp_url&entry.${selectedForm.entryId}=${encodeURIComponent(examNumber)}`;

      return prefilledUrl;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚€
    function loadForm(level) {
      const formUrl = generatePrefilledUrl(level);
      if (formUrl) {
        document.getElementById('form-iframe').src = formUrl;
        document.getElementById('form-container').classList.remove('hidden');
        document.getElementById('form-container').classList.add('active');
        document.querySelector('.level-buttons').classList.add('hidden');
        document.getElementById('level-instruction').classList.add('hidden');
        document.getElementById('result-check-area').classList.remove('hidden');
        document.getElementById('result-check-area').classList.add('clickable');

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        document.getElementById('scroll-to-top').classList.add('visible');
      }
    }

    // ä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // çµæœã‚’ç¢ºèª
    async function checkResult() {
      // SessionStorageã‹ã‚‰å—é¨“ç•ªå·ã¨ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—
      const examNumber = sessionStorage.getItem('quizSessionExamNumber');
      const kentei = sessionStorage.getItem('quizSessionKentei') || KENTEI_NAME;
      const level = sessionStorage.getItem('quizSessionLevel');
      const sheetIndex = sessionStorage.getItem('quizSessionSheetIndex');

      if (!examNumber) {
        console.log('å—é¨“ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      if (!level) {
        console.log('ãƒ¬ãƒ™ãƒ«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // ãƒ¬ãƒ™ãƒ«ã«å¯¾å¿œã™ã‚‹GAS URLã‚’å–å¾—
      const gasApiUrl = GAS_API_URLS[kentei] && GAS_API_URLS[kentei][level];
      if (!gasApiUrl) {
        console.log(`${kentei} ${level} ã®GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
        return;
      }

      // é€£æ‰“é˜²æ­¢
      const resultCheckArea = document.getElementById('result-check-area');
      resultCheckArea.classList.remove('clickable');
      resultCheckArea.style.opacity = '0.5';
      resultCheckArea.style.cursor = 'not-allowed';

      // UIã®åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('result').classList.add('hidden');
      document.getElementById('form-iframe').classList.add('hidden');

      try {
        // GASã«å—é¨“ç•ªå·ã¨ã‚·ãƒ¼ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é€ä¿¡ã—ã¦çµæœã‚’å–å¾—
        let apiUrl = `${gasApiUrl}?action=getResult&examNumber=${encodeURIComponent(examNumber)}`;

        // ã‚·ãƒ¼ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒã‚ã‚Œã°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ ï¼ˆGASå´ã§æ¤œç´¢ç¯„å›²ã‚’çµã‚‹ï¼‰
        if (sheetIndex !== null) {
          apiUrl += `&sheetIndex=${encodeURIComponent(sheetIndex)}`;
        }

        const response = await fetch(apiUrl);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        document.getElementById('loading').classList.add('hidden');

        if (data.error) {
          // ã‚¨ãƒ©ãƒ¼ã®å ´åˆï¼ˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼‰
          // å†åº¦ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
          resultCheckArea.classList.add('clickable');
          resultCheckArea.style.opacity = '1';
          resultCheckArea.style.cursor = 'pointer';

          // ä¸€æ™‚çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          showTemporaryMessage('åˆå¦åˆ¤å®šãŒç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ•°åˆ†å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚<br>ãã‚Œã§ã‚‚è§£æ±ºã—ãªã„å ´åˆã€ãŠæ‰‹æ•°ã§ã™ãŒã‚‚ã†ä¸€åº¦ãƒˆãƒƒãƒ—ç”»é¢ã‹ã‚‰æ”¹ã‚ã¦å—é¨“ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚');
          document.getElementById('form-iframe').classList.remove('hidden');

        } else if (data.pass) {
          // åˆæ ¼ã®å ´åˆ
          // çµæœç¢ºèªã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
          resultCheckArea.classList.add('hidden');

          // æ¤œå®šåãƒ»ãƒ¬ãƒ™ãƒ«åã‚’å–å¾—
          const kenteiDisplayName = KENTEI_DISPLAY_NAMES[kentei] || kentei;
          const levelDisplayName = LEVEL_DISPLAY_NAMES[level] || level;

          // åˆæ ¼è¨¼ç”»åƒã®HTMLï¼ˆBase64ã¾ãŸã¯URLï¼‰
          let certificatePreviewHtml = '';
          if (data.certificateImageBase64) {
            certificatePreviewHtml = `<img id="certificate-preview" src="${data.certificateImageBase64}" alt="åˆæ ¼è¨¼" style="max-width: 100%; height: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px;">`;
          } else if (data.certificateImageUrl) {
            certificatePreviewHtml = `<img id="certificate-preview" src="${data.certificateImageUrl}" alt="åˆæ ¼è¨¼" style="max-width: 100%; height: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px;">`;
          }

          document.getElementById('result').innerHTML = `
            <p style="font-size: 16px; color: #666;">ã‚ãªãŸã®${kenteiDisplayName} ${levelDisplayName} ã®çµæœã¯â€¦</p>
            <div class="success-icon">ğŸŠ</div>
            <h2>åˆæ ¼</h2>
            <div class="message">
              ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>åˆæ ¼è¨¼ãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸï¼
            </div>
            <div style="margin: 20px 0;">
              <div style="position: relative; display: inline-block; margin: 20px 0;">
                ${certificatePreviewHtml}
              </div>
              <div style="margin-top: 15px;">
                <button class="retry-button" onclick="downloadCertificate()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">åˆæ ¼è¨¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <p class="download-help">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ããªã„å ´åˆã¯<a href="${data.certificateImageBase64 || data.certificateImageUrl}" target="_blank">ã“ã¡ã‚‰</a>ã‹ã‚‰åˆ¥ã‚¿ãƒ–ã§é–‹ã„ã¦ä¿å­˜ã—ã¦ãã ã•ã„</p>
              </div>
            </div>
            <button class="retry-button" onclick="resetView()">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã«æŒ‘æˆ¦ã™ã‚‹</button>
            <button class="retry-button" onclick="shareToX(true)" style="background: linear-gradient(135deg, #1DA1F2 0%, #0d8bd9 100%); margin-top: 10px;">Xã«å…±æœ‰ã™ã‚‹</button>
          `;
          document.getElementById('result').classList.remove('hidden');

          // åˆæ ¼è¨¼æƒ…å ±ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆBase64ã‚’å„ªå…ˆï¼‰
          window.currentCertificate = {
            imageData: data.certificateImageBase64 || data.certificateImageUrl,
            kentei: data.kentei,
            level: data.level,
            kenteiDisplayName: KENTEI_DISPLAY_NAMES[data.kentei] || data.kentei,
            levelDisplayName: LEVEL_DISPLAY_NAMES[data.level] || data.level,
            score: data.score
          };

          // ä¸€ç•ªä¸Šã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          window.scrollTo({ top: 0, behavior: 'smooth' });

        } else {
          // ä¸åˆæ ¼ã®å ´åˆ
          // çµæœç¢ºèªã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
          resultCheckArea.classList.add('hidden');

          // æ¤œå®šåãƒ»ãƒ¬ãƒ™ãƒ«åã‚’å–å¾—
          const kenteiDisplayName = KENTEI_DISPLAY_NAMES[kentei] || kentei;
          const levelDisplayName = LEVEL_DISPLAY_NAMES[level] || level;

          document.getElementById('result').innerHTML = `
            <p style="font-size: 16px; color: #666;">ã‚ãªãŸã®${kenteiDisplayName} ${levelDisplayName} ã®çµæœã¯â€¦</p>
            <div class="fail-icon">ğŸ˜¢</div>
            <h2>ä¸åˆæ ¼</h2>
            <div class="message">
              ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å¾Œã®ç”»é¢ã«ã‚ã‚‹ã€Œã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€åˆæ ¼ã™ã‚‹ãŸã‚ã®ãƒ’ãƒ³ãƒˆãŒç¢ºèªã§ãã¾ã™ã€‚<br>
              ãƒ’ãƒ³ãƒˆã‚’è¦‹ã¦ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã‚ˆã†ï¼
            </div>
            <button class="retry-button" onclick="resetView()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>
            <button class="retry-button" onclick="shareToX(false)" style="background: linear-gradient(135deg, #1DA1F2 0%, #0d8bd9 100%); margin-top: 10px;">Xã«å…±æœ‰ã™ã‚‹</button>
          `;
          document.getElementById('result').classList.remove('hidden');

          // ä¸€ç•ªä¸Šã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          window.scrollTo({ top: 0, behavior: 'smooth' });
          document.getElementById('form-iframe').classList.remove('hidden');
          document.getElementById('form-iframe').classList.add('shorter');
        }

      } catch (error) {
        console.error('çµæœå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('loading').classList.add('hidden');

        // å†åº¦ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
        resultCheckArea.classList.add('clickable');
        resultCheckArea.style.opacity = '1';
        resultCheckArea.style.cursor = 'pointer';

        // ä¸€æ™‚çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        showTemporaryMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }

    // ä¸€æ™‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆ10ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆãˆã‚‹ï¼‰
    function showTemporaryMessage(message) {
      const messageElement = document.getElementById('temporary-message');
      messageElement.innerHTML = message;
      messageElement.classList.remove('hidden');

      // 10ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
      setTimeout(() => {
        messageElement.classList.add('hidden');
      }, 10000);
    }

    // åˆæ ¼è¨¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadCertificate() {
      if (!window.currentCertificate || !window.currentCertificate.imageData) {
        showTemporaryMessage('åˆæ ¼è¨¼ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      try {
        // Base64ãƒ‡ãƒ¼ã‚¿ã®å ´åˆ
        if (window.currentCertificate.imageData.startsWith('data:')) {
          const a = document.createElement('a');
          a.href = window.currentCertificate.imageData;
          a.download = `åˆæ ¼è¨¼_${window.currentCertificate.kenteiDisplayName}_${window.currentCertificate.levelDisplayName}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          showTemporaryMessage('åˆæ ¼è¨¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
        } else {
          // URLå½¢å¼ã®å ´åˆã€fetchã—ã¦å¤‰æ›
          fetch(window.currentCertificate.imageData)
            .then(res => res.blob())
            .then(blob => {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `åˆæ ¼è¨¼_${window.currentCertificate.kenteiDisplayName}_${window.currentCertificate.levelDisplayName}.png`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              showTemporaryMessage('åˆæ ¼è¨¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
            })
            .catch(error => {
              console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
              showTemporaryMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }
      } catch (error) {
        console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        showTemporaryMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // Xã«å…±æœ‰
    function shareToX(isPassed) {
      const kentei = sessionStorage.getItem('quizSessionKentei') || KENTEI_NAME;
      const level = sessionStorage.getItem('quizSessionLevel');

      if (!level) {
        showTemporaryMessage('ãƒ¬ãƒ™ãƒ«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      const kenteiDisplayName = KENTEI_DISPLAY_NAMES[kentei] || kentei;
      const levelDisplayName = LEVEL_DISPLAY_NAMES[level] || level;

      let tweetText = '';
      if (isPassed) {
        // åˆæ ¼æ™‚
        const score = window.currentCertificate ? window.currentCertificate.score : 100;
        tweetText = SHARE_CONFIG.passedMessage
          .replace('{kentei}', kenteiDisplayName)
          .replace('{level}', levelDisplayName)
          .replace('{score}', score);
      } else {
        // ä¸åˆæ ¼æ™‚
        tweetText = SHARE_CONFIG.failedMessage
          .replace('{kentei}', kenteiDisplayName)
          .replace('{level}', levelDisplayName);
      }

      // ãƒšãƒ¼ã‚¸URLã‚’è¿½åŠ 
      let pageUrl = SHARE_CONFIG.pageUrl;
      if (!pageUrl) {
        // è¨­å®šãŒãªã„å ´åˆã¯ç¾åœ¨ã®ãƒšãƒ¼ã‚¸URLã‚’ä½¿ç”¨ï¼ˆlocalhostã‚’é™¤ãï¼‰
        pageUrl = window.location.href;
        if (pageUrl.includes('localhost')) {
          pageUrl = '';
        }
      }

      if (pageUrl) {
        tweetText += `\n\n${pageUrl}`;
      }

      // Xã®ã‚·ã‚§ã‚¢URLã‚’æ§‹ç¯‰
      const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;

      // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
      window.open(shareUrl, '_blank', 'width=550,height=420');
    }

    // ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetView() {
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('form-container').classList.remove('active');
      document.getElementById('form-container').classList.add('hidden');

      // å„ç¨®è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('result').classList.add('hidden');

      // ãƒªã‚»ãƒƒãƒˆ
      const resultCheckArea = document.getElementById('result-check-area');
      resultCheckArea.classList.add('hidden');
      resultCheckArea.classList.remove('clickable');
      resultCheckArea.style.opacity = '1';
      resultCheckArea.style.cursor = 'default';

      // iframeã‚’ã‚¯ãƒªã‚¢ãƒ»ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
      const iframe = document.getElementById('form-iframe');
      iframe.src = 'about:blank';
      iframe.classList.remove('hidden', 'shorter');

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢
      window.currentCertificate = null;

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      document.getElementById('scroll-to-top').classList.remove('visible');

      // ãƒ¬ãƒ™ãƒ«é¸æŠãƒœã‚¿ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’å†è¡¨ç¤º
      document.querySelector('.level-buttons').classList.remove('hidden');
      document.getElementById('level-instruction').classList.remove('hidden');
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å—é¨“ç•ªå·ã‚’ç”Ÿæˆã—è¡¨ç¤º
    window.addEventListener('DOMContentLoaded', function() {
      // æ¤œå®šåã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
      const kenteiTitle = document.getElementById('kentei-title');
      kenteiTitle.textContent = KENTEI_DISPLAY_NAMES[KENTEI_NAME] || KENTEI_NAME;

      // ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
      const levelButtonsContainer = document.getElementById('level-buttons-container');
      levelButtonsContainer.innerHTML = '';
      const levels = Object.keys(GAS_API_URLS[KENTEI_NAME]);
      const buttonClasses = ['beginner', 'intermediate', 'advanced'];

      levels.forEach((level, index) => {
        const button = document.createElement('button');
        button.className = `level-button ${buttonClasses[index] || 'beginner'}`;
        button.onclick = function() { loadForm(level); };
        button.textContent = LEVEL_DISPLAY_NAMES[level] || level;
        levelButtonsContainer.appendChild(button);
      });

      // å—é¨“ç•ªå·ã‚’ç”Ÿæˆã¾ãŸã¯å–å¾—
      let examNumber = sessionStorage.getItem('quizSessionExamNumber');

      if (!examNumber) {
        examNumber = generateExamNumber();

        try {
          sessionStorage.setItem('quizSessionExamNumber', examNumber);

          // ä¿å­˜ç¢ºèª
          const saved = sessionStorage.getItem('quizSessionExamNumber');

          if (saved !== examNumber) {
            console.error('âŒ å—é¨“ç•ªå·ä¿å­˜æ¤œè¨¼: å¤±æ•— - å€¤ãŒä¸€è‡´ã—ã¾ã›ã‚“');
            console.error('  æœŸå¾…å€¤:', examNumber);
            console.error('  å®Ÿéš›å€¤:', saved);
            showTemporaryMessage('å—é¨“ç•ªå·ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹ã«ã—ã¦ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
          }
        } catch (storageError) {
          console.error('âŒ SessionStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', storageError);
          showTemporaryMessage('å—é¨“ç•ªå·ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹ã«ã—ã¦ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
      }
    });
  </script>
</body>
</html>