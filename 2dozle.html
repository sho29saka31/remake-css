<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
/* ãƒ‰ã‚ºãƒ«æ¤œå®šç”¨ã‚¹ã‚¿ã‚¤ãƒ« - ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼: #C80000 */

body {
  font-family: 'Helvetica Neue', Arial, sans-serif;
  max-width: 800px;
  margin: 0 auto;
  padding: 0;
  background: transparent;
}

.container {
  background: white;
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

h1 {
  color: #C80000;
  text-align: center;
  margin: 0 0 5px 0;
  font-size: 28px;
  font-weight: bold;
}

.subtitle {
  text-align: center;
  color: #666;
  margin: 0 0 15px 0;
  font-size: 14px;
}

.exam-number-display {
  background: linear-gradient(135deg, #C80000 0%, #8B0000 100%);
  color: white;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  margin: 15px 0;
  font-size: 16px;
  font-weight: bold;
}

.exam-number-value {
  font-size: 32px;
  letter-spacing: 4px;
  font-family: 'Courier New', monospace;
  margin: 10px 0;
}

.level-buttons {
  display: flex;
  flex-direction: row;
  gap: 15px;
  margin-bottom: 20px;
}

.level-button {
  flex: 1;
  padding: 18px 10px;
  font-size: 18px;
  font-weight: bold;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  color: white;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  text-align: center;
  border: none;
}

.level-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

.beginner {
  background: linear-gradient(135deg, #FF6B6B 0%, #C80000 100%);
}

.intermediate {
  background: linear-gradient(135deg, #C80000 0%, #8B0000 100%);
}

.advanced {
  background: linear-gradient(135deg, #8B0000 0%, #4A0000 100%);
}

.form-container {
  margin-top: 20px;
  display: none;
}

.form-container.active {
  display: block;
}

#form-iframe {
  width: 100%;
  height: 800px;
  border: none;
  border-radius: 8px;
}

.result-button {
  width: 100%;
  padding: 15px;
  font-size: 18px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: linear-gradient(135deg, #C80000 0%, #8B0000 100%);
  color: white;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  margin-top: 20px;
  transition: all 0.3s ease;
}

.result-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

.hidden {
  display: none;
}

.result-display {
  margin-top: 20px;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
}

.success-icon {
  font-size: 64px;
  margin-bottom: 20px;
}

.fail-icon {
  font-size: 64px;
  margin-bottom: 20px;
}

.error-icon {
  font-size: 64px;
  margin-bottom: 20px;
}

.result-display h2 {
  margin: 0 0 15px 0;
  font-size: 28px;
}

.result-display .message {
  font-size: 16px;
  margin-bottom: 20px;
  color: #666;
}

.result-display .details {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-top: 15px;
}

.result-display .details h3 {
  margin: 0 0 10px 0;
  font-size: 18px;
  color: #333;
}

.result-display .details p {
  margin: 5px 0;
  color: #666;
}

.loading {
  text-align: center;
  padding: 40px;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #C80000;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.retry-button {
  padding: 12px 24px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: linear-gradient(135deg, #C80000 0%, #8B0000 100%);
  color: white;
  margin-top: 15px;
}

.retry-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.temporary-message {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #C80000;
  color: white;
  padding: 15px 25px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 1000;
  font-size: 16px;
  font-weight: bold;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

.gorilla-area {
  padding: 15px 20px;
  margin: 20px 0;
  font-size: 20px;
  font-weight: bold;
  text-align: center;
  color: white;
  background: linear-gradient(135deg, #FF6B6B 0%, #C80000 100%);
  border-radius: 12px;
  cursor: default;
  user-select: none;
}

.gorilla-area.clickable {
  cursor: pointer;
  transition: all 0.3s ease;
}

.gorilla-area.clickable:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(200, 0, 0, 0.5);
}
  </style>
</head>
<body>
  <div class="container">
    <h1 id="kentei-title">æ¤œå®š</h1>

    <!-- ã‚¯ãƒªãƒƒã‚¯ã‚¨ãƒªã‚¢ï¼ˆçµæœç¢ºèªç”¨ï¼‰ -->
    <div id="gorilla-click-area" class="gorilla-area hidden" onclick="checkResult()">
      æ¤œå®šã‚’å—ã‘ã¦åˆæ ¼è¨¼ã‚’ã‚²ãƒƒãƒˆã—ã‚ˆã†ï¼
    </div>

    <p class="subtitle" id="level-instruction">ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>

    <div class="level-buttons" id="level-buttons-container">
      <button class="level-button beginner" onclick="loadForm('Lv1')">Lv1</button>
      <button class="level-button intermediate" onclick="loadForm('Lv2')">Lv2</button>
      <button class="level-button advanced" onclick="loadForm('Lv3')">Lv3</button>
    </div>

    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <h2>åˆæ ¼è¨¼ã‚’ç¢ºèªä¸­...</h2>
      <p class="message">å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</p>
    </div>

    <div id="result" class="result-display hidden"></div>

    <div class="form-container" id="form-container">
      <iframe id="form-iframe"></iframe>
    </div>

    <div id="temporary-message" class="temporary-message hidden"></div>

  </div>

  <script>
    // ============================================
    // è¨­å®š: ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿å¤‰æ›´ã—ã¦ãã ã•ã„
    // ============================================

    // æ¤œå®šè¨­å®š
    const KENTEI_CONFIG = {
      'G1': {
        displayName: 'æ¤œå®šå',
        levels: {
          'Lv1': {
            displayName: 'åˆç´š',
            gasApiUrl: 'https://script.google.com/macros/s/YOUR_GAS_DEPLOY_URL_LV1/exec',
            forms: [
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_1/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_2/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_3/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_4/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_5/viewform', entryId: 'YOUR_ENTRY_ID' }
            ]
          },
          'Lv2': {
            displayName: 'ä¸­ç´š',
            gasApiUrl: 'https://script.google.com/macros/s/YOUR_GAS_DEPLOY_URL_LV2/exec',
            forms: [
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_1/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_2/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_3/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_4/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_5/viewform', entryId: 'YOUR_ENTRY_ID' }
            ]
          },
          'Lv3': {
            displayName: 'ä¸Šç´š',
            gasApiUrl: 'https://script.google.com/macros/s/YOUR_GAS_DEPLOY_URL_LV3/exec',
            forms: [
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_1/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_2/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_3/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_4/viewform', entryId: 'YOUR_ENTRY_ID' },
              { url: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID_5/viewform', entryId: 'YOUR_ENTRY_ID' }
            ]
          }
        }
      }
    };

    // ============================================
    // ä»¥ä¸‹ã¯å¤‰æ›´ä¸è¦ï¼ˆè‡ªå‹•çš„ã«å°å‡ºã•ã‚Œã‚‹ï¼‰
    // ============================================

    // ç¾åœ¨ã®æ¤œå®šè¨­å®šã‹ã‚‰å€¤ã‚’å–å¾—
    const KENTEI_NAME = Object.keys(KENTEI_CONFIG)[0];  // 'G1'
    const CURRENT_KENTEI = KENTEI_CONFIG[KENTEI_NAME];
    const LEVEL_NAMES = Object.keys(CURRENT_KENTEI.levels);  // ['Lv1', 'Lv2', 'Lv3']

    // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã€æ—¢å­˜ã®å½¢å¼ã§ã‚‚å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    const KENTEI_DISPLAY_NAMES = {
      [KENTEI_NAME]: CURRENT_KENTEI.displayName
    };

    const LEVEL_DISPLAY_NAMES = {};
    LEVEL_NAMES.forEach(level => {
      LEVEL_DISPLAY_NAMES[level] = CURRENT_KENTEI.levels[level].displayName;
    });

    const GAS_API_URLS = {
      [KENTEI_NAME]: {}
    };
    LEVEL_NAMES.forEach(level => {
      GAS_API_URLS[KENTEI_NAME][level] = CURRENT_KENTEI.levels[level].gasApiUrl;
    });

    const FORM_CONFIG = {
      [KENTEI_NAME]: {}
    };
    LEVEL_NAMES.forEach(level => {
      FORM_CONFIG[KENTEI_NAME][level] = CURRENT_KENTEI.levels[level].forms;
    });


    // å—é¨“ç•ªå·ç”Ÿæˆé–¢æ•°ï¼ˆ6æ¡è‹±æ•°å­—ï¼‰
    function generateExamNumber() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let examNumber = '';
      for (let i = 0; i < 6; i++) {
        examNumber += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return examNumber;
    }

    // ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãƒ—ãƒªãƒ•ã‚£ãƒ«URLã‚’ç”Ÿæˆ
    function generatePrefilledUrl(level) {
      const kentei = KENTEI_NAME;
      const forms = FORM_CONFIG[kentei][level];

      if (!forms || forms.length === 0) {
        console.error('ã‚¨ãƒ©ãƒ¼: ã“ã®ãƒ¬ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return '';
      }

      // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸æŠ
      const randomIndex = Math.floor(Math.random() * forms.length);
      const selectedForm = forms[randomIndex];

      // å—é¨“ç•ªå·ã‚’å–å¾—
      const examNumber = sessionStorage.getItem('quizSessionExamNumber');

      // é¸æŠã—ãŸãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’SessionStorageã«ä¿å­˜ï¼ˆGASæ¤œç´¢ç”¨ï¼‰
      sessionStorage.setItem('quizSessionKentei', kentei);
      sessionStorage.setItem('quizSessionLevel', level);
      sessionStorage.setItem('quizSessionSheetIndex', randomIndex.toString());

      // ãƒ—ãƒªãƒ•ã‚£ãƒ«URLã‚’æ§‹ç¯‰
      const prefilledUrl = `${selectedForm.url}?usp=pp_url&entry.${selectedForm.entryId}=${encodeURIComponent(examNumber)}`;

      return prefilledUrl;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚€
    function loadForm(level) {
      const formUrl = generatePrefilledUrl(level);
      if (formUrl) {
        document.getElementById('form-iframe').src = formUrl;
        document.getElementById('form-container').classList.add('active');
        document.querySelector('.level-buttons').classList.add('hidden');
        document.getElementById('level-instruction').classList.add('hidden');
        document.getElementById('gorilla-click-area').classList.remove('hidden');
        document.getElementById('gorilla-click-area').classList.add('clickable');
      }
    }

    // çµæœã‚’ç¢ºèª
    async function checkResult() {
      // SessionStorageã‹ã‚‰å—é¨“ç•ªå·ã¨ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—
      const examNumber = sessionStorage.getItem('quizSessionExamNumber');
      const kentei = sessionStorage.getItem('quizSessionKentei') || KENTEI_NAME;
      const level = sessionStorage.getItem('quizSessionLevel');
      const sheetIndex = sessionStorage.getItem('quizSessionSheetIndex');

      if (!examNumber) {
        console.log('å—é¨“ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      if (!level) {
        console.log('ãƒ¬ãƒ™ãƒ«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // ãƒ¬ãƒ™ãƒ«ã«å¯¾å¿œã™ã‚‹GAS URLã‚’å–å¾—
      const gasApiUrl = GAS_API_URLS[kentei] && GAS_API_URLS[kentei][level];
      if (!gasApiUrl) {
        console.log(`${kentei} ${level} ã®GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
        return;
      }

      // é€£æ‰“é˜²æ­¢
      const gorillaArea = document.getElementById('gorilla-click-area');
      gorillaArea.classList.remove('clickable');
      gorillaArea.style.opacity = '0.5';
      gorillaArea.style.cursor = 'not-allowed';

      // UIã®åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('result').classList.add('hidden');

      try {
        // GASã«å—é¨“ç•ªå·ã¨ã‚·ãƒ¼ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é€ä¿¡ã—ã¦çµæœã‚’å–å¾—
        let apiUrl = `${gasApiUrl}?action=getResult&examNumber=${encodeURIComponent(examNumber)}`;

        // ã‚·ãƒ¼ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒã‚ã‚Œã°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ ï¼ˆGASå´ã§æ¤œç´¢ç¯„å›²ã‚’çµã‚‹ï¼‰
        if (sheetIndex !== null) {
          apiUrl += `&sheetIndex=${encodeURIComponent(sheetIndex)}`;
        }

        const response = await fetch(apiUrl, {
          method: 'GET',
          mode: 'cors'
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        document.getElementById('loading').classList.add('hidden');

        if (data.error) {
          // ã‚¨ãƒ©ãƒ¼ã®å ´åˆï¼ˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼‰
          // å†åº¦ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
          gorillaArea.classList.add('clickable');
          gorillaArea.style.opacity = '1';
          gorillaArea.style.cursor = 'pointer';

          // ä¸€æ™‚çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          showTemporaryMessage('ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');

        } else if (data.pass) {
          // åˆæ ¼ã®å ´åˆ
          // åˆæ ¼è¨¼ç”»åƒã®HTMLï¼ˆBase64ã¾ãŸã¯URLï¼‰
          let certificatePreviewHtml = '';
          if (data.certificateImageBase64) {
            certificatePreviewHtml = `<img id="certificate-preview" src="${data.certificateImageBase64}" alt="åˆæ ¼è¨¼" style="max-width: 100%; height: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px;">`;
          } else if (data.certificateImageUrl) {
            certificatePreviewHtml = `<img id="certificate-preview" src="${data.certificateImageUrl}" alt="åˆæ ¼è¨¼" style="max-width: 100%; height: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px;">`;
          }

          document.getElementById('result').innerHTML = `
            <div class="success-icon">ğŸ‰</div>
            <h2>åˆæ ¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™!</h2>
            <div class="message">
              æº€ç‚¹ã§ã™! ç´ æ™´ã‚‰ã—ã„çµæœã§ã™!
            </div>
            <div style="margin: 20px 0;">
              <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <div>
                  <label style="display: block; margin-bottom: 5px; font-weight: bold; text-align: left;">ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</label>
                  <input type="text" id="certificate-name" placeholder="å±±ç”° å¤ªéƒ" style="padding: 10px; font-size: 16px; border: 2px solid #667eea; border-radius: 8px; width: 250px;">
                </div>
                <button class="retry-button" onclick="updateCertificateName()" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); margin-top: 22px;">åå‰ã‚’åæ˜ </button>
              </div>
              <div style="position: relative; display: inline-block; margin: 20px 0;">
                <canvas id="certificate-canvas" style="max-width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; display: none;"></canvas>
                ${certificatePreviewHtml}
              </div>
              <div style="margin-top: 15px;">
                <button class="retry-button" onclick="downloadCertificate()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
              </div>
            </div>
            <div class="details">
              <h3>çµæœè©³ç´°</h3>
              <p><strong>æ¤œå®š:</strong> ${data.kentei}</p>
              <p><strong>ãƒ¬ãƒ™ãƒ«:</strong> ${data.level}</p>
              <p><strong>ã‚¹ã‚³ã‚¢:</strong> ${data.score}ç‚¹ / 100ç‚¹</p>
            </div>
            <button class="retry-button" onclick="resetView()">åˆ¥ã®ãƒ¬ãƒ™ãƒ«ã«æŒ‘æˆ¦ã™ã‚‹</button>
          `;
          document.getElementById('result').classList.remove('hidden');

          // åˆæ ¼è¨¼æƒ…å ±ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆBase64ã‚’å„ªå…ˆï¼‰
          window.currentCertificate = {
            imageData: data.certificateImageBase64 || data.certificateImageUrl,
            kentei: data.kentei,
            level: data.level,
            kenteiDisplayName: KENTEI_DISPLAY_NAMES[data.kentei] || data.kentei,
            levelDisplayName: LEVEL_DISPLAY_NAMES[data.level] || data.level,
            score: data.score
          };

          // ä¸€ç•ªä¸Šã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          window.scrollTo({ top: 0, behavior: 'smooth' });

        } else {
          // ä¸åˆæ ¼ã®å ´åˆ
          document.getElementById('result').innerHTML = `
            <div class="fail-icon">ğŸ˜¢</div>
            <h2>ä¸åˆæ ¼</h2>
            <div class="message">
              ã¾ãŸã‚„ã‚ã†
            </div>
            <div class="details">
              <p style="margin-top: 15px; color: #667eea; font-weight: bold;">ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å¾Œã®ç”»é¢ã§ã€Œã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã‹ã‚‰è©³ç´°ãªçµæœã‚’ç¢ºèªã§ãã¾ã™</p>
            </div>
            <button class="retry-button" onclick="resetView()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>
          `;
          document.getElementById('result').classList.remove('hidden');

          // ä¸€ç•ªä¸Šã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

      } catch (error) {
        console.error('çµæœå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('loading').classList.add('hidden');

        // å†åº¦ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
        gorillaArea.classList.add('clickable');
        gorillaArea.style.opacity = '1';
        gorillaArea.style.cursor = 'pointer';

        // ä¸€æ™‚çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        showTemporaryMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }

    // ä¸€æ™‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆ10ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆãˆã‚‹ï¼‰
    function showTemporaryMessage(message) {
      const messageElement = document.getElementById('temporary-message');
      messageElement.textContent = message;
      messageElement.classList.remove('hidden');

      // 10ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
      setTimeout(() => {
        messageElement.classList.add('hidden');
      }, 10000);
    }

    // åˆæ ¼è¨¼ã«åå‰ã‚’åæ˜ 
    function updateCertificateName() {
      const nameInput = document.getElementById('certificate-name');
      const name = nameInput.value.trim();

      if (!name) {
        showTemporaryMessage('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (!window.currentCertificate || !window.currentCertificate.imageData) {
        showTemporaryMessage('åˆæ ¼è¨¼ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      const canvas = document.getElementById('certificate-canvas');
      const preview = document.getElementById('certificate-preview');
      const ctx = canvas.getContext('2d');

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      showTemporaryMessage('ç”»åƒã‚’ç”Ÿæˆä¸­...');

      // ç”»åƒã‚’èª­ã¿è¾¼ã¿
      const img = new Image();

      img.onload = function() {
        // Canvasã‚µã‚¤ã‚ºã‚’ç”»åƒã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
        canvas.width = img.width;
        canvas.height = img.height;

        // ç”»åƒã‚’æç”»
        ctx.drawImage(img, 0, 0);

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
        const today = new Date();
        const dateStr = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // åˆæ ¼è¨¼ã‚¿ã‚¤ãƒˆãƒ«
        ctx.fillStyle = '#333333';
        ctx.font = 'bold ' + Math.floor(img.width * 0.06) + 'px "Yu Gothic", "Hiragino Sans", sans-serif';
        ctx.fillText('åˆæ ¼è¨¼', img.width / 2, img.height * 0.2);

        // åå‰
        ctx.font = 'bold ' + Math.floor(img.width * 0.08) + 'px "Yu Gothic", "Hiragino Sans", sans-serif';
        ctx.fillText(name + ' æ®¿', img.width / 2, img.height * 0.4);

        // åˆæ ¼æ–‡
        ctx.font = Math.floor(img.width * 0.04) + 'px "Yu Gothic", "Hiragino Sans", sans-serif';
        ctx.fillText(`ã‚ãªãŸã¯ ${window.currentCertificate.kenteiDisplayName} ${window.currentCertificate.levelDisplayName} ã«`, img.width / 2, img.height * 0.55);
        ctx.fillText('åˆæ ¼ã—ãŸã“ã¨ã‚’è¨¼ã—ã¾ã™', img.width / 2, img.height * 0.62);

        // æ—¥ä»˜
        ctx.font = Math.floor(img.width * 0.035) + 'px "Yu Gothic", "Hiragino Sans", sans-serif';
        ctx.fillText(dateStr, img.width / 2, img.height * 0.75);

        // ã‚¹ã‚³ã‚¢
        ctx.font = 'bold ' + Math.floor(img.width * 0.04) + 'px "Yu Gothic", "Hiragino Sans", sans-serif';
        ctx.fillText(`ã‚¹ã‚³ã‚¢: ${window.currentCertificate.score}ç‚¹`, img.width / 2, img.height * 0.85);

        // Canvasã‚’è¡¨ç¤ºã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
        canvas.style.display = 'block';
        preview.style.display = 'none';

        showTemporaryMessage('åˆæ ¼è¨¼ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼');
      };

      img.onerror = function(e) {
        console.error('ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        showTemporaryMessage('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      };

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ãã‚Œã‚’ä½¿ç”¨ï¼ˆBase64ã§ã‚‚URLã§ã‚‚å‹•ä½œï¼‰
      const previewImg = document.getElementById('certificate-preview');
      if (previewImg && previewImg.complete && previewImg.naturalWidth > 0) {
        img.src = previewImg.src;
      } else {
        img.src = window.currentCertificate.imageData;
      }
    }

    // åˆæ ¼è¨¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadCertificate() {
      if (!window.currentCertificate || !window.currentCertificate.imageData) {
        showTemporaryMessage('åˆæ ¼è¨¼ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      const canvas = document.getElementById('certificate-canvas');
      const preview = document.getElementById('certificate-preview');

      // CanvasãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆåå‰å…¥åŠ›æ¸ˆã¿ï¼‰
      if (canvas.style.display !== 'none') {
        canvas.toBlob(function(blob) {
          if (!blob) {
            showTemporaryMessage('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            return;
          }

          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `åˆæ ¼è¨¼_${window.currentCertificate.kenteiDisplayName}_${window.currentCertificate.levelDisplayName}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showTemporaryMessage('åˆæ ¼è¨¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
        });
        return;
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆåå‰å…¥åŠ›å‰ï¼‰
      try {
        // Base64ãƒ‡ãƒ¼ã‚¿ã®å ´åˆ
        if (window.currentCertificate.imageData.startsWith('data:')) {
          const a = document.createElement('a');
          a.href = window.currentCertificate.imageData;
          a.download = `åˆæ ¼è¨¼_${window.currentCertificate.kenteiDisplayName}_${window.currentCertificate.levelDisplayName}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          showTemporaryMessage('åˆæ ¼è¨¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
        } else {
          // URLå½¢å¼ã®å ´åˆã€fetchã—ã¦å¤‰æ›
          fetch(window.currentCertificate.imageData)
            .then(res => res.blob())
            .then(blob => {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `åˆæ ¼è¨¼_${window.currentCertificate.kenteiDisplayName}_${window.currentCertificate.levelDisplayName}.png`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              showTemporaryMessage('åˆæ ¼è¨¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
            })
            .catch(error => {
              console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
              showTemporaryMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }
      } catch (error) {
        console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        showTemporaryMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetView() {
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('form-container').classList.remove('active');
      document.getElementById('form-container').classList.add('hidden');

      // å„ç¨®è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('result').classList.add('hidden');

      // ãƒªã‚»ãƒƒãƒˆ
      const gorillaArea = document.getElementById('gorilla-click-area');
      gorillaArea.classList.add('hidden');
      gorillaArea.classList.remove('clickable');
      gorillaArea.style.opacity = '1';
      gorillaArea.style.cursor = 'default';

      // iframeã‚’ã‚¯ãƒªã‚¢
      const iframe = document.getElementById('form-iframe');
      iframe.src = 'about:blank';

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢
      window.currentCertificate = null;

      // ãƒ¬ãƒ™ãƒ«é¸æŠãƒœã‚¿ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’å†è¡¨ç¤º
      document.querySelector('.level-buttons').classList.remove('hidden');
      document.getElementById('level-instruction').classList.remove('hidden');
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å—é¨“ç•ªå·ã‚’ç”Ÿæˆã—è¡¨ç¤º
    window.addEventListener('DOMContentLoaded', function() {
      // æ¤œå®šåã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
      const kenteiTitle = document.getElementById('kentei-title');
      kenteiTitle.textContent = KENTEI_DISPLAY_NAMES[KENTEI_NAME] || KENTEI_NAME;

      // ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
      const levelButtonsContainer = document.getElementById('level-buttons-container');
      levelButtonsContainer.innerHTML = '';
      const levels = Object.keys(GAS_API_URLS[KENTEI_NAME]);
      const buttonClasses = ['beginner', 'intermediate', 'advanced'];

      levels.forEach((level, index) => {
        const button = document.createElement('button');
        button.className = `level-button ${buttonClasses[index] || 'beginner'}`;
        button.onclick = function() { loadForm(level); };
        button.textContent = LEVEL_DISPLAY_NAMES[level] || level;
        levelButtonsContainer.appendChild(button);
      });

      // å—é¨“ç•ªå·ã‚’ç”Ÿæˆã¾ãŸã¯å–å¾—
      let examNumber = sessionStorage.getItem('quizSessionExamNumber');

      if (!examNumber) {
        examNumber = generateExamNumber();

        try {
          sessionStorage.setItem('quizSessionExamNumber', examNumber);

          // ä¿å­˜ç¢ºèª
          const saved = sessionStorage.getItem('quizSessionExamNumber');

          if (saved !== examNumber) {
            console.error('âŒ å—é¨“ç•ªå·ä¿å­˜æ¤œè¨¼: å¤±æ•— - å€¤ãŒä¸€è‡´ã—ã¾ã›ã‚“');
            console.error('  æœŸå¾…å€¤:', examNumber);
            console.error('  å®Ÿéš›å€¤:', saved);
          }
        } catch (storageError) {
          console.error('âŒ SessionStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', storageError);
        }
      }
    });
  </script>
</body>
</html>
